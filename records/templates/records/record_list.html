{% extends "core/base.html" %}

{% block content %}
<style>
  .records-actions { text-align: center; }
  .records-actions .btn-primary{
    padding: .55rem 1.25rem;
    box-shadow: 0 2px 8px rgba(13,110,253,.18);
    transition: filter .15s ease, box-shadow .15s ease;
  }
  .records-actions .btn-primary:hover{
    filter: brightness(0.95);
    box-shadow: 0 4px 14px rgba(13,110,253,.28);
  }

  .records-search { text-align: center; }
  .records-search .form-control{
    max-width: 380px;
    margin: 0 auto;
  }

  .records-table-wrap { max-width: 960px; margin: 0 auto; }

  td.actions-cell { text-align: center; }
  .actions-inline { display: inline-flex; gap: .5rem; }
</style>

<div class="container mt-5">
  <h2 class="text-center mb-2">Kartoteka medyczna</h2>
  <p class="text-center text-muted mb-4">
    Wgrywaj wyniki badań, wypisy, zdjęcia i inne dokumenty.
  </p>

  <div class="records-actions mb-3">
    <form method="post" enctype="multipart/form-data" id="uploadForm" class="d-inline-block m-0">
      {% csrf_token %}
      <input type="file" name="file" id="fileInput" class="d-none">
      <button type="button" id="addFileBtn" class="btn btn-primary">Dodaj plik</button>
    </form>
  </div>

  <div class="records-search mb-3">
    <form method="get" class="m-0">
      <input
        type="text"
        id="filterInput"
        name="q"
        value="{{ q }}"
        class="form-control"
        placeholder="Filtruj po nazwie pliku…">
    </form>
  </div>

  {% if files %}
    <div class="records-table-wrap table-responsive">
      <table class="table table-bordered table-hover align-middle bg-white shadow-sm" id="filesTable">
        <thead class="table-light">
          <tr>
            <th>Nazwa pliku</th>
            <th style="width: 220px;" class="text-center">Akcje</th>
          </tr>
        </thead>
        <tbody>
          {% for f in files %}
          <tr>
            <td class="text-break">{{ f.original_name }}</td>
            <td class="actions-cell">
              <div class="actions-inline">
                <a href="{{ f.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener">
                  Otwórz
                </a>
                <a href="{% url 'records:delete' f.pk %}" class="btn btn-sm btn-outline-danger">
                  Usuń
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
          <tr id="noResultsRow" style="display:none;">
            <td colspan="2" class="text-center text-muted">Brak pliku o takiej nazwie.</td>
          </tr>
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-center text-muted">Nie dodano jeszcze żadnych plików.</p>
  {% endif %}
</div>

<script>
  const addBtn = document.getElementById('addFileBtn');
  const fileInput = document.getElementById('fileInput');
  const uploadForm = document.getElementById('uploadForm');

  if (addBtn && fileInput && uploadForm) {
    addBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length > 0) uploadForm.submit();
    });
  }

  (function(){
    const filterInput = document.getElementById('filterInput');
    const table = document.getElementById('filesTable');
    const noRow = document.getElementById('noResultsRow');
    if (!filterInput || !table) return;

    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(
      tr => tr !== noRow
    );

    function applyFilter() {
      const q = (filterInput.value || '').toLowerCase().trim();
      let visible = 0;
      rows.forEach(tr => {
        const name = tr.cells[0]?.textContent?.toLowerCase() || '';
        const show = name.includes(q);
        tr.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (noRow) noRow.style.display = visible === 0 ? '' : 'none';
    }
    filterInput.addEventListener('input', applyFilter);
    applyFilter();
  })();
</script>
{% endblock %}
